<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
	<!-- Bootstrap CSS -->
	<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
	<!-- Custom CSS -->
	<link rel="stylesheet" href="../css/style.css" />
	<link rel="stylesheet" href="../css/style-phone.css">
    <link rel="stylesheet" href="../css/about.css" />
    <link rel="stylesheet" href="../css/about-phone.css" />
	<link href="https://fonts.googleapis.com/css?family=Josefin+Sans:300,400&display=swap" rel="stylesheet">
	<link rel='icon' href='../img/favicon.png' type='image/x-icon' />
	<title>Resource-19</title>
	<!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-161941609-1"></script>
	<!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-161941609-1"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'UA-161941609-1');
	</script>
	<!-- jQuery -->
	<script src="https://code.jquery.com/jquery-3.4.1.min.js"
			integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
			crossorigin="anonymous"></script>
	<!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
	<script src="https://www.gstatic.com/firebasejs/7.13.0/firebase-app.js"></script>
	<script src="https://www.gstatic.com/firebasejs/7.12.0/firebase-auth.js"></script>
	<script src="https://www.gstatic.com/firebasejs/7.13.0/firebase-analytics.js"></script>
	<script src="../js/firebase_init.js"></script>
</head>

<body>
	<!-- Navbar -->
    <nav id="navbar" class="navbar navbar-expand-md navbar-light navbar-custom bg-light"></nav>


    <section>
		<h1>Submit a design!</h1>
		<p class="subtitle">If you have a open source design to contribute to the makerspace, please submit it here!</p>
	</section>

	<script src="https://static.airtable.com/js/embed/embed_snippet_v1.js"></script>
    
    <form class="form">
        <div class="form-row">	
            <div class="form-group col-xs-12 col-6">	
                <label for="name">Design Name</label>
                <input  class="form-control" placeholder="Design Name" id="submission_name" name="name" type="text" />
            </div>	
            <div class="form-group col-xs-12 col-6">	
                <label for="category">Category</label>
                <select class="form-control" name="category" id="submission_category">
                    <option value="n95">N95</option>
                    <option value="surgicalMask">Surgical Mask</option>
                    <option value="ventilator">Ventilator</option>
                    <option value="ventilatorParts">Ventilator Parts</option>
                    <option value="faceShield">Face Shield</option>
                    <option value="hospitalGown">Hospital Gown</option>
                    <option value="handSanitizer">Hand Sanitizer</option>
                    <option value="disposableBooties">Disposable Booties</option>
                    <option value="miscParts">Misc Parts</option>
                    <option value="other">Other</option>
                </select>
            </div>	
        </div>	

        <div class="form-row">		
            <div class="form-group col-12">
                <label for="description">Description</label>
                <textarea class="form-control" placeholder="Description" id="submission_description" name="description"></textarea>
            </div>
        </div>	
        
        <div class="form-row">		
            <div class="form-group col-12">
                <label for="certified">Certified</label>
                <p>Certification will be qualified as having the design certified by the NIH, CDC, ECDC, or on equivalent organization. In progress will indicate the design is in process of approval but has not yet reached it. </p>
                <select class="form-control" name="certified" id="submission_certified">
                    <option value="yes">Yes</option>
                    <option value="no">No</option>
                    <option value="inProgress">In Progress</option>
                </select>
            </div>
        </div>	

        <div class="form-row">
            <div class="form-group col-6">
                <label for="difficulty">Difficulty Level (1 Being Easy and 5 Being Hard)</label>
                <input class="form-control" type="number" max="5" min="1" name="difficulty" id="submission_difficulty"/>
            </div>
            <div class="form-group col-6">
                <label for="3d">3D Printer Required?</label>
                <select class="form-control" id="submission_3d" name="3d">
                    <option value="true">Yes</option>
                    <option value="false">No</option>
                </select>
            </div>
        </div>	

        <div class="form-row">
            <div class="form-group col-12">
                <label for="links">Links (Links separated by commas)</label>
                <textarea class="form-control" placeholder="Links" type="text" name="links" id="submission_links"></textarea>
            </div>
        </div>	

        <div class="form-row">
            <div class="form-group col-12">
                <label for="images">Images</label>
                <p>Intended for Pictures (JPG, PNG)</p>
                <input class=".form-control-file." type="file" name="images" id="submission_images" multiple/>
            </div>
        </div>	

        <div class="form-row">
            <div class="form-group col-12">
                <label for="attachments">Attachments</label>
                <p>Intended for Pictures, CAD files, etc...</p>
                <input class=".form-control-file." type="file" name="attachments" id="submission_attachments" multiple/>
            </div>
        </div>	

        <div class="form-row">
            <div class="form-group col-12">
                <label for="credit">Credit</label>
                <p>Give credit where credit is due. Who made this design possible?</p>
                <input class="form-control" type="text" name="credit" id="submission_credit"/>
            </div>
        </div>	

        <div class="form-row justify-content-center">	
            <!-- Submit -->	
            <div class="form-group col-6">	
                <input type="button" value="Submit" class="form-control submit" id="submission_submit" />	
            </div>	
        </div>	
    </form>

    <!-- JavaScript -->
	<script>
		// load html components
		$("#navbar").load("../components/navbar.html");
	</script>
	<!-- Popper.js -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
		integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
		crossorigin="anonymous"></script>
	<!-- Bootstrap js -->
	<script src="../bootstrap-4.0.0-dist/js/bootstrap.min.js"></script>
    
    <!-- The core Firebase JS SDK is always required and must be listed first -->
	<script src="https://www.gstatic.com/firebasejs/7.13.0/firebase-app.js"></script>

	<!-- TODO: Add SDKs for Firebase products that you want to use
		https://firebase.google.com/docs/web/setup#available-libraries -->
	<script src="https://www.gstatic.com/firebasejs/7.12.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.13.0/firebase-storage.js"></script>	
    <script src="https://www.gstatic.com/firebasejs/7.12.0/firebase-auth.js"></script>


    <script src="../database.js"></script>
	<script>

        document.getElementById("submission_submit").addEventListener("click", (e) => {
            try {
                handleSubmission(e)
            } catch(err) {
                console.log(err)
            }
        });

        function handleSubmission(event) {
            // Get all values
            let name = document.getElementById("submission_name"),
                category = document.getElementById("submission_category"),
                description = document.getElementById("submission_description"),
                certified = document.getElementById("submission_certified"),
                difficulty = document.getElementById("submission_difficulty"),
                links = document.getElementById("submission_links"),
                threed = document.getElementById("submission_3d"),
                images = document.getElementById("submission_images"),
                attachments = document.getElementById("submission_attachments"),
                credit = document.getElementById("submission_credit"),
                design = {};

            name = name.value;
            if(name == null || name.trim() == "") throw new Error("Invalid Name");
            design["name"] = name;
            
            category = category.value;
            if(category == null) throw new Error("Invalid Category");
            design["category"] = category;

            description = description.value;
            if(description == null || description.trim() == "") throw new Error("Invalid Description");
            design["description"] = description;
            design["notes"] = "";

            certified = certified.value;
            if(certified == null) throw new Error("Invalid Certified");
            design["certified"] = certified;

            difficulty = difficulty.value;
            if(difficulty == null) throw new Error("Invalid difficulty");
            design["difficulty"] = difficulty;

            links = links.value.split(",").map((l) => {
                return l.trim()
            });
            design["links"] = links;

            threed = threed.value;
            if(threed == null) throw new Error("Invalid 3d");
            threed = (threed == "true") ? true : false;
            design["printerRequired"] = threed;

            credit = credit.value;
            if(credit == null) throw new Error("Inavlid Credit")
            design["credit"] = credit;


            let imagePromises = []
            if(images.files.length < 1) throw new Error("Not Enough Attachments");
            for(let i = 0; i < images.files.length; i++) {
                let file = images.files[i];
                imagePromises.push(new Promise((resolve, reject) => {
                    let filePut = storageRef.child("Attachments/" + file.name).put(file);
                    filePut.on(firebase.storage.TaskEvent.STATE_CHANGED,
                    (snapshot) => {
                        var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        console.log('Upload is ' + progress + '% done');
                    },
                    (error) => {
                        console.log(error);
                    },
                    () => {
                        filePut.snapshot.ref.getDownloadURL().then(function(downloadURL) {
                            console.log('File available at', downloadURL);
                            resolve({
                                name: file.name,
                                url: downloadURL
                            });
                        });
                    });
                }));
            }


            let attachmentPromises = []
            if(attachments.files.length < 1) throw new Error("Not Enough Attachments");
            for(let i = 0; i < attachments.files.length; i++) {
                let file = attachments.files[i];
                console.log(file);
                attachmentPromises.push(new Promise((resolve, reject) => {
                    let filePut = storageRef.child("Attachments/" + file.name).put(file);
                    filePut.on(firebase.storage.TaskEvent.STATE_CHANGED,
                    (snapshot) => {
                        var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        console.log('Upload is ' + progress + '% done');
                    },
                    (error) => {
                        console.log(error);
                    },
                    () => {
                        filePut.snapshot.ref.getDownloadURL().then(function(downloadURL) {
                            console.log('File available at', downloadURL);
                            resolve({
                                name: file.name,
                                url: downloadURL
                            });
                        });
                    });
                }));
            }

            Promise.all([Promise.all(imagePromises), Promise.all(attachmentPromises)]).then((res) => {
                console.log(res)
                design["images"] = res[0];
                design["attachments"] = res[1];
                design["upvotes"] = 0;
                design["approved"] = true;

                let design_ref = db.collection("Designs").doc().id;
                console.log(design_ref);
                design["id"] = design_ref;
                db.collection("Designs").doc(design_ref).set(design);
                submissionSuccess();
            });

        }

        function submissionSuccess() {
            console.log("Submission Success");
        }
    </script>
</body>

</html>
